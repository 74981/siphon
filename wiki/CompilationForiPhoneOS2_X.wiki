#summary Compilation guide for iPhone OS 2.X.

= Introduction =

This article describes the steps to generate pjsip on Mac OS X 10.5.5


= Details =

==Get pjsip source code==
Get [http://pjsip.org PjSIP] from subversion repository:

{{{
svn checkout http://svn.pjsip.org/repos/pjproject/trunk pjproject
}}}


==Modify some files==

===aconfigure.ac===

In _aconfigure.ac_ file add the lines below displayed with '+'. Of course copy without '+' ;-)

{{{
 if test "$enable_sound" = "no"; then
   true;
 else
  case $target in
+   arm-apple-darwin*)
+        LIBS="$LIBS -framework CoreAudio -framework CoreFoundation -framework AudioToolbox"
+        ac_pjmedia_snd=iphone
+        AC_MSG_RESULT([Checking sound device backend... AudioQueue])
+        ;;
   *darwin*)
 	LIBS="$LIBS -framework CoreAudio -framework CoreServices -framework AudioUnit -framework AudioToolbox"
 	if test "`uname -r`" = "6.8"; then
}}}



===build/rules.mak===
In _rules.mak_ modify, remove lines with '-' and add lines with '+':
{{{
 $(LIB): $(OBJDIRS) $(OBJS) $($(APP)_EXTRA_DEP)
 	if test ! -d $(LIBDIR); then $(subst @@,$(subst /,$(HOST_PSEP),$(LIBDIR)),$(HOST_MKDIR)); fi
-	$(AR) $(LIB) $(OBJS)
-	$(RANLIB) $(LIB)
+	$(RANLIB) -static -o $(LIB) $(OBJS)
}}}
===pjlib/include/pj/compat/os_darwinos.h===
In _os_darwinos.h_ find and comment the following lines :
{{{
/*
 * Socket related
 */
//typedef int socklen_t;
}}}

Without this, you will get an error when you will compile, because socklen_t is redefined. 

===pjmedia/build/os-auto.mak.in===
In _os-auto.mak.in_, add the line with '+'
{{{
 #   - ds:	    	Win32 DirectSound (dsound.c)
+#   - iphone:       iPhone AudioQueue (iphonesound.c)
 #   - null:	    	Null sound device (nullsound.c)
}}}

Add the line below, for example between "Win 32 Direct Sound" and " Null Sound Device"

{{{
#
# iPod/iPhone
#
ifeq ($(AC_PJMEDIA_SND),iphone)
export SOUND_OBJS = iphonesound.o
export CFLAGS += -DPJMEDIA_SOUND_IMPLEMENTATION=PJMEDIA_SOUND_IPHONE_SOUND
endif

}}}

We have defined a new target for sound device.

===pjmedia/include/pjmedia/config.h===
in _config.h_ add the lines below with '+':

{{{
 /** Constant for Win32 MME sound backend. */
 #define PJMEDIA_SOUND_WIN32_MME_SOUND	    3

+/** Constant for AudioQueue sound backend. */
+#define PJMEDIA_SOUND_IPHONE_SOUND            4
}}}

===pjmedia/src/pjmedia===
For the moment I didn't upload iphonesound.c so we need to compile with null_sound.

==Configuration==
Generate configuration script
{{{
autoconf aconfigure.ac > aconfigure
}}}

==Compilation==

iPhone SDK doesn't provide some programs without version number, so we create symbolic link. We should test before create link, but we are very lazy.
Copy the line below in file with name like _compile.sh_ in the root of pjsip.

{{{
#!/bin/sh

export DEV=/Developer/Platforms/iPhoneOS.platform/Developer
export SDK=${DEV}/SDKs/iPhoneOS2.1.sdk

pushd ${DEV}/usr/bin
ln -s arm-apple-darwin9-gcc-4.0.1 arm-apple-darwin9-gcc
ln -s arm-apple-darwin9-g++-4.0.1 arm-apple-darwin9-g++
ln -s ranlib arm-apple-darwin9-ranlib
popd

export PATH=${DEV}/usr/bin:${PATH}

export CFLAGS="-O2 -arch armv6 \
	-I${SDK}/usr/include \
	-I${DEV}/usr/lib/gcc/arm-apple-darwin9/4.0.1/include \
	-I/usr/include -F${SDK}/System/Library/Frameworks"

export LDFLAGS="-O2 -arch armv6 \
	-L${SDK}/usr/lib \
	-F${SDK}/System/Library/Frameworks"

export CPP="${DEV}/usr/bin/cpp"

./aconfigure --host=arm-apple-darwin9 --disable-speex-aec \
   --disable-speex-codec --disable-l16-codec --disable-g722-codec \
   --disable-ilbc-codec --disable-ssl --disable-sound

make dep
make
}}}

We don't forget to change access right to allow execution.
We can run _compile.sh_ after some minutes pjsip is compiled.